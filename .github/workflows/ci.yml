name: "Contentstack CI"

on:
  push:
    branches: [ master, next ]
  pull_request:
    branches: [ master, next ]

jobs:
  macOS:
    name: Test macOS
    runs-on: macos-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Ruby (for installing Bundler and Fastlane)
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'

    - name: Install dep via Carthage
      run: |
        carthage bootstrap --platform macOS --use-xcframeworks --cache-builds
      
    - name: Install dependencies via Swift Package Manager
      run: swift package resolve

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4.0'
    
    - name: List available schemes
      run: |
        xcodebuild -list -project Contentstack.xcodeproj
    - name: List available schemes workspace
      run: |
        xcodebuild -list -workspace Contentstack.xcworkspace

    - name: Build and run tests
      run: |
        xcodebuild test \
          -workspace Contentstack.xcworkspace \
          -scheme "Contentstack macOS Tests" \
          -destination 'platform=macOS,arch=arm64' \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGNING_ALLOWED=NO
  iOS:
    name: Test iOS
    runs-on: macos-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Ruby (for installing Bundler and Fastlane)
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    
    - name: Install dep via Carthage
      run: |
        carthage bootstrap --platform iOS --use-xcframeworks --cache-builds
      
    - name: Install dependencies via Swift Package Manager
      run: swift package resolve

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4.0'

    - name: Build and run tests
      run: |
        xcodebuild test \
          -workspace Contentstack.xcworkspace \
          -scheme "Contentstack iOS Tests" \
          -destination 'platform=iOS Simulator,name=iPhone 14,OS=latest' \
          -sdk iphonesimulator \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGNING_ALLOWED=NO